# BIOMS 报表系统权限说明文档

## 一、角色定义

系统根据用户的 `shopId` 和 `roleIdTotal` 字段来判断用户角色：

| 角色 | 判断条件 | 中文名称 |
|------|---------|---------|
| ADMIN | shopId = 0 | 管理员 |
| MANAGER | roleIdTotal = 41 | 店长 |
| EMPLOYEE | 其他情况 | 销售员 |

---

## 二、报表页面功能概览

### 2.1 页面结构

报表页面（`/report`）包含以下模块：

1. **顶部导航栏**：显示用户信息（用户ID、角色、门店）和登出按钮
2. **筛选条件区**：门店、销售员、日期范围筛选
3. **KPI指标卡片**：总销量、总销售额、商品种类数、订单数
4. **商品销售数量排行榜**：以柱状图和表格展示商品销量排名
5. **商品销售金额排行榜**：以柱状图和表格展示商品销售额排名

### 2.2 筛选功能

#### 门店筛选
- 下拉选择框，可选"全部门店"或具体门店
- 不同角色看到的选项不同（见下方详细说明）

#### 销售员筛选
- 下拉选择框，可选"全部销售员"或具体销售员
- 联动筛选：选择门店和日期范围后，销售员列表会自动过滤
- 不同角色看到的选项不同（见下方详细说明）

#### 日期筛选
- **自定义日期**：开始日期和结束日期输入框
- **快捷日期选择**：
  - 今日
  - 近7天
  - 本月
  - 上月
  - 上上月
  - 今年

---

## 三、管理员（ADMIN）角色

### 3.1 权限特征

**数据范围**：无限制，可查看全公司所有数据

**特权标识**：`shopId = 0`

### 3.2 报表查看效果

#### 筛选器权限

| 筛选项 | 可见范围 | 说明 |
|--------|---------|------|
| 门店 | 所有门店 | 可选择任意门店或"全部门店" |
| 销售员 | 所有销售员 | 根据已选门店和日期范围联动显示销售员列表 |
| 日期 | 无限制 | 可选择任意日期范围 |

#### 数据展示

**场景1：不筛选任何条件**
```
门店：全部门店
销售员：全部销售员
日期：本月（默认）
```
**展示结果**：
- KPI卡片：全公司本月的总销量、总销售额、商品种类数、订单数
- 排行榜：全公司本月所有商品的销量/销售额排名

**场景2：筛选特定门店**
```
门店：深圳旗舰店
销售员：全部销售员
日期：今年
```
**展示结果**：
- KPI卡片：深圳旗舰店今年的总销量、总销售额、商品种类数、订单数
- 排行榜：深圳旗舰店今年所有商品的销量/销售额排名

**场景3：筛选特定销售员**
```
门店：全部门店
销售员：张三
日期：上月
```
**展示结果**：
- KPI卡片：销售员张三上月的总销量、总销售额、商品种类数、订单数
- 排行榜：销售员张三上月销售的所有商品的销量/销售额排名

**场景4：同时筛选门店和销售员**
```
门店：北京中关村店
销售员：李四
日期：近7天
```
**展示结果**：
- KPI卡片：北京中关村店销售员李四近7天的总销量、总销售额、商品种类数、订单数
- 排行榜：北京中关村店销售员李四近7天销售的所有商品的销量/销售额排名

### 3.3 业务目的

1. **全局监控**：掌握全公司的整体销售情况和趋势
2. **门店对比**：对比不同门店的销售业绩，识别表现优异或需要改进的门店
3. **销售员管理**：跨门店查看任意销售员的业绩，支持人力资源决策
4. **商品策略**：了解全公司范围内的畅销商品和滞销商品，制定采购和营销策略
5. **绩效考核**：为门店和销售员的绩效考核提供数据支撑
6. **经营决策**：基于全局数据进行战略规划和资源配置

---

## 四、店长（MANAGER）角色

### 4.1 权限特征

**数据范围**：仅限所属门店的数据

**特权标识**：`roleIdTotal = 41` 且有特定的 `shopId`

**权限限制**：
- 门店筛选被锁定为自己的门店
- 只能查看本门店的销售员数据

### 4.2 报表查看效果

#### 筛选器权限

| 筛选项 | 可见范围 | 说明 |
|--------|---------|------|
| 门店 | 仅自己的门店 | 下拉框只显示一个选项（自己的门店），实际被锁定 |
| 销售员 | 本门店所有销售员 | 根据日期范围联动显示本门店的销售员列表 |
| 日期 | 无限制 | 可选择任意日期范围 |

#### 数据展示

**假设店长所属门店为"上海徐家汇店"**

**场景1：不筛选销售员**
```
门店：上海徐家汇店（锁定）
销售员：全部销售员
日期：本月
```
**展示结果**：
- KPI卡片：上海徐家汇店本月的总销量、总销售额、商品种类数、订单数
- 排行榜：上海徐家汇店本月所有商品的销量/销售额排名

**场景2：筛选特定销售员**
```
门店：上海徐家汇店（锁定）
销售员：王五（店内某销售员）
日期：上月
```
**展示结果**：
- KPI卡片：销售员王五上月的总销量、总销售额、商品种类数、订单数
- 排行榜：销售员王五上月销售的所有商品的销量/销售额排名

**场景3：对比不同时间段**
```
门店：上海徐家汇店（锁定）
销售员：全部销售员
日期：上上月 → 切换为 上月 → 切换为 本月
```
**展示结果**：
- 可以通过切换日期快捷按钮，对比门店在不同时间段的销售情况

### 4.3 业务目的

1. **门店管理**：全面掌握本门店的销售业绩和运营状况
2. **团队管理**：监控门店内各销售员的业绩表现
3. **销售员激励**：根据数据识别优秀销售员和需要辅导的销售员
4. **库存管理**：了解本门店的畅销商品，优化进货计划
5. **目标达成**：跟踪门店销售目标的完成情况
6. **问题发现**：及时发现销售异常，采取改进措施
7. **公平考核**：为门店内销售员的绩效考核提供客观依据

**权限限制的合理性**：
- 店长无需查看其他门店数据，聚焦本门店管理
- 避免跨门店数据泄露和不必要的竞争
- 确保门店店长专注于提升本门店业绩

---

## 五、销售员（EMPLOYEE）角色

### 5.1 权限特征

**数据范围**：仅限个人销售数据

**权限限制**：
- 销售员筛选被锁定为自己
- 可以查看任意门店，但数据永远只显示自己的销售记录

### 5.2 报表查看效果

#### 筛选器权限

| 筛选项 | 可见范围 | 说明 |
|--------|---------|------|
| 门店 | 所有门店 | 理论上可选择任意门店，但实际数据只显示自己的 |
| 销售员 | 仅自己 | 下拉框只显示自己的ID/姓名，实际被锁定 |
| 日期 | 无限制 | 可选择任意日期范围 |

#### 数据展示

**假设当前登录的销售员是"赵六"（userId: zhao6）**

**场景1：查看个人业绩**
```
门店：全部门店
销售员：赵六（锁定）
日期：本月
```
**展示结果**：
- KPI卡片：赵六本月的总销量、总销售额、商品种类数、订单数
- 排行榜：赵六本月销售的所有商品的销量/销售额排名

**场景2：指定门店查看（实际无效）**
```
门店：广州天河店
销售员：赵六（锁定）
日期：今年
```
**展示结果**：
- KPI卡片：赵六今年在广州天河店的销售数据（如果赵六在该店有销售记录）
- 排行榜：赵六今年在广州天河店销售的商品排名
- **注意**：如果赵六从未在广州天河店工作或销售，数据为空

**场景3：查看不同时间段的个人业绩**
```
门店：全部门店
销售员：赵六（锁定）
日期：今日 → 近7天 → 本月 → 今年
```
**展示结果**：
- 可以通过快捷日期切换，查看自己在不同时间段的销售业绩变化

### 5.3 业务目的

1. **业绩自查**：随时查看自己的销售数据，了解个人业绩表现
2. **目标跟踪**：跟踪个人销售目标的完成进度
3. **商品分析**：了解自己销售的哪些商品最畅销，优化销售策略
4. **自我激励**：通过数据可视化增强成就感和动力
5. **工作总结**：为个人工作汇报和总结提供数据依据
6. **技能提升**：分析不同商品的销售情况，找到提升销售技巧的方向

**权限限制的合理性**：
- 保护其他销售员的数据隐私
- 避免内部不必要的攀比和竞争
- 让销售员专注于提升个人业绩
- 防止数据滥用和泄露

**门店筛选的特殊说明**：
- 虽然销售员可以选择不同门店，但这个筛选器对销售员来说实际意义不大
- 因为后端会强制将销售员筛选条件锁定为当前登录用户
- 门店筛选器显示给销售员主要是为了界面一致性，但不影响权限控制

---

## 六、权限控制技术实现

### 6.1 前端权限

**路由保护**：
- 使用 `ProtectedRoute` 组件包裹报表页面
- 未登录用户自动重定向到登录页

**筛选器联动**：
- 门店列表根据用户角色动态加载（`/api/filters/shops`）
- 销售员列表根据用户角色、已选门店和日期范围动态加载（`/api/filters/salespeople`）

**用户信息展示**：
- 顶部导航栏显示当前用户的角色和门店信息
- 便于用户明确自己的权限范围

### 6.2 后端权限

**认证机制**：
- 所有API请求必须携带用户信息（通过 `x-user-info` 请求头，Base64编码）
- 后端通过 `getUserFromRequest()` 解析用户信息
- 无效请求返回 401 未授权错误

**权限过滤**：

1. **门店筛选（`getShopFilter()`）**：
   ```
   管理员：使用请求参数中的门店（可为空）
   店长：强制使用用户的 shopName
   销售员：使用请求参数中的门店（但不影响销售员筛选）
   ```

2. **销售员筛选（`getSalespersonFilterAsync()`）**：
   ```
   管理员：使用请求参数中的销售员（可为空）
   店长：使用请求参数中的销售员（但限制在本门店范围内）
   销售员：强制使用用户的 userId（转换为 userName）
   ```

**API端点权限**：

| API端点 | 权限控制 |
|---------|---------|
| `/api/report/kpi` | 应用门店和销售员筛选 |
| `/api/report/ranking-quantity` | 应用门店和销售员筛选 |
| `/api/report/ranking-sales` | 应用门店和销售员筛选 |
| `/api/filters/shops` | 根据角色返回不同的门店列表 |
| `/api/filters/salespeople` | 根据角色返回不同的销售员列表 |

### 6.3 数据库查询

**查询优化**：
- 使用索引加速查询（`shop`, `doneSales1`, `payTime`）
- 复合索引支持多条件筛选

**数据过滤**：
- 在SQL查询层面应用权限过滤条件
- 确保用户只能查询到有权限的数据

---

## 七、报表数据说明

### 7.1 KPI指标

| 指标 | 说明 | 计算方式 |
|------|------|---------|
| 总销量 | 商品销售总数量 | SUM(goodsNum) where status=1,2,3,4 |
| 总销售额 | 商品销售总金额 | SUM(goodsNum * goodsPrice) where status=1,2,3,4 |
| 商品种类数 | 不同商品的数量 | COUNT(DISTINCT goodsName) where status=1,2,3,4 |
| 订单数 | 订单总数 | COUNT(DISTINCT orderSn) where status=1,2,3,4 |

**订单状态说明**：
- 只统计状态为 1、2、3、4 的订单（已完成的有效订单）
- 排除其他状态的订单（如已取消、退款等）

### 7.2 排行榜数据

**商品销售数量排行榜**：
- 按商品名称（`goodsName`）分组
- 按销量（`SUM(goodsNum)`）降序排列
- 默认显示 TOP 20

**商品销售金额排行榜**：
- 按商品名称（`goodsName`）分组
- 按销售额（`SUM(goodsNum * goodsPrice)`）降序排列
- 默认显示 TOP 20

**展示形式**：
- 柱状图：直观展示排名和数值对比
- 数据表格：详细展示排名、商品名称、规格、数值
- 点击商品可查看详细信息（商品详情弹窗）

### 7.3 数据来源

**主要数据表**：
- `shop_order`：订单主表
- `shop_order_goods`：订单商品明细表
- `sales_person`：销售员信息表

**关联查询**：
- 通过 `orderSn` 关联订单和商品
- 通过 `doneSales1`（userId）关联销售员

---

## 八、使用建议

### 8.1 管理员使用建议

1. **日常监控**：每天查看"本月"数据，监控整体业绩进展
2. **门店对比**：定期切换不同门店，对比各门店业绩
3. **销售员排名**：查看不同销售员的业绩，识别明星员工
4. **趋势分析**：对比"本月"、"上月"、"上上月"数据，分析趋势
5. **商品决策**：关注排行榜，了解畅销品和滞销品，调整策略

### 8.2 店长使用建议

1. **团队管理**：每天查看门店整体数据和各销售员数据
2. **目标跟踪**：将实际数据与门店目标对比，及时调整
3. **辅导下属**：根据数据识别需要辅导的销售员
4. **激励团队**：公开表彰业绩优秀的销售员
5. **商品管理**：根据排行榜优化门店库存和陈列

### 8.3 销售员使用建议

1. **每日自查**：每天查看"今日"和"本月"数据，了解进度
2. **目标管理**：对照个人目标，调整销售节奏
3. **产品聚焦**：关注排行榜，重点推销畅销商品
4. **技能提升**：分析销售数据，总结成功经验
5. **工作汇报**：使用数据为工作汇报提供依据

---

## 九、常见问题解答

### Q1：为什么销售员可以选择不同门店，但数据不变？

**A**：销售员的门店筛选器主要是为了界面一致性而保留的。虽然销售员可以选择门店，但后端会强制将销售员筛选条件锁定为当前登录用户，因此无论选择哪个门店，显示的都是该销售员在该门店（或所有门店）的个人数据。

### Q2：店长能看到其他门店的数据吗？

**A**：不能。店长的门店筛选被强制锁定为自己所属的门店，前端和后端都会进行权限限制，确保店长只能查看本门店的数据。

### Q3：管理员可以查看已离职销售员的数据吗？

**A**：可以。只要在数据库中有历史销售记录，管理员可以通过选择该销售员来查看其历史数据。但前端的销售员列表默认只显示在选定日期范围内有销售记录的销售员。

### Q4：数据统计的时间范围是如何计算的？

**A**：系统使用订单的 `payTime`（支付时间）字段进行时间筛选，开始日期从 00:00:00 开始，结束日期到 23:59:59 结束。快捷日期选择会自动设置正确的时间范围。

### Q5：为什么有时候KPI数据为0？

**A**：可能的原因：
1. 选定的筛选条件下确实没有销售数据
2. 销售员在选定的门店/时间范围内没有销售记录
3. 所有订单的状态不符合统计条件（status不为1,2,3,4）

### Q6：排行榜最多显示多少条数据？

**A**：默认显示 TOP 20 条数据。如果实际商品种类少于20种，则显示所有商品。

### Q7：如何确认自己的角色和权限？

**A**：登录后，页面顶部导航栏会显示当前用户的角色和门店信息。如有疑问，请联系系统管理员。

---

## 十、安全性说明

### 10.1 数据安全

1. **强制认证**：所有API请求必须通过认证，未授权请求被拒绝
2. **权限隔离**：不同角色严格隔离数据访问权限
3. **后端验证**：前端筛选条件在后端重新验证和过滤，防止篡改
4. **参数编码**：用户信息通过Base64编码传输，避免特殊字符问题

### 10.2 隐私保护

1. **最小权限原则**：每个角色只能访问履行职责所需的最少数据
2. **个人数据保护**：销售员只能看到自己的数据，无法查看其他销售员数据
3. **门店数据隔离**：店长之间的数据相互隔离

### 10.3 审计追踪

建议在生产环境中添加以下功能（当前版本未实现）：
- API访问日志记录
- 用户操作审计
- 异常访问告警

---

## 十一、版本信息

**文档版本**：v1.0
**系统版本**：2024
**最后更新**：2024-12-24
**适用用户**：全体系统用户

---

## 十二、总结

BIOMS报表系统通过精细的权限设计，实现了不同角色的数据隔离和访问控制：

- **管理员**拥有全局视野，支持战略决策和全面管理
- **店长**聚焦门店运营，支持团队管理和业绩提升
- **销售员**关注个人业绩，支持自我管理和技能提升

系统在保障数据安全的前提下，为各角色提供了清晰、实用的数据分析工具，助力企业提升销售管理效率和业务决策质量。
